// Prisma schema for POS/ERP backend (PostgreSQL)
// Run after network is available:
// npx prisma migrate dev --name init
// npx prisma generate

generator client {
  provider = "prisma-client-js"
}

// New: Sections and Tables
model Section {
  id        String   @id @default(uuid())
  name      String
  branch    Branch   @relation(fields: [branchId], references: [id])
  branchId  String

  tables    Table[]
  priceLists PriceList[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Table {
  id         String   @id @default(uuid())
  name       String
  status     String   @default("available") // available, occupied, locked
  section    Section  @relation(fields: [sectionId], references: [id])
  sectionId  String

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([sectionId, name])
}

// New: Price lists and entries (optional section scoping)
model PriceList {
  id        String   @id @default(uuid())
  name      String
  active    Boolean  @default(true)
  branch    Branch   @relation(fields: [branchId], references: [id])
  branchId  String
  section   Section? @relation(fields: [sectionId], references: [id])
  sectionId String?

  entries   PriceEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PriceEntry {
  id          String    @id @default(uuid())
  priceList   PriceList @relation(fields: [priceListId], references: [id])
  priceListId String
  product     Product   @relation(fields: [productId], references: [id])
  productId   String
  price       Decimal   @db.Decimal(12, 2)

  createdAt   DateTime  @default(now())

  @@unique([priceListId, productId])
}

// New: Payments linked to orders
model Payment {
  id        String   @id @default(uuid())
  order     Order    @relation(fields: [orderId], references: [id])
  orderId   String
  method    String
  amount    Decimal  @db.Decimal(12, 2)
  reference String?
  meta      Json?
  createdAt DateTime @default(now())
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  CASHIER
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
}

model User {
  id          String   @id @default(uuid())
  username    String   @unique
  email       String   @unique
  passwordHash String
  role        Role     @default(CASHIER)

  branch      Branch?  @relation(fields: [branchId], references: [id])
  branchId    String?

  orders      Order[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Branch {
  id        String      @id @default(uuid())
  name      String
  location  String

  users     User[]
  products  Product[]
  inventory Inventory[]
  orders    Order[]
  sections  Section[]
  priceLists PriceList[]

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([name])
}

model Product {
  id        String      @id @default(uuid())
  name      String
  sku       String      @unique
  category  String?
  price     Decimal     @db.Decimal(12, 2)
  taxRate   Decimal?    @db.Decimal(5, 2)

  branch    Branch      @relation(fields: [branchId], references: [id])
  branchId  String

  inventory Inventory[]
  orderItems OrderItem[]
  priceEntries PriceEntry[]

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([name])
  @@index([branchId])
}

model Inventory {
  id         String   @id @default(uuid())
  product    Product  @relation(fields: [productId], references: [id])
  productId  String
  branch     Branch   @relation(fields: [branchId], references: [id])
  branchId   String
  qtyOnHand  Int      @default(0)
  minLevel   Int      @default(0)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([productId, branchId])
}

model Order {
  id        String       @id @default(uuid())
  branch    Branch       @relation(fields: [branchId], references: [id])
  branchId  String
  user      User?        @relation(fields: [userId], references: [id])
  userId    String?

  status    OrderStatus  @default(PAID)
  total     Decimal      @db.Decimal(12, 2)

  items     OrderItem[]
  payments  Payment[]

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([branchId])
  @@index([userId])
  @@index([createdAt])
}

model OrderItem {
  id        String   @id @default(uuid())
  order     Order    @relation(fields: [orderId], references: [id])
  orderId   String
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  qty       Int
  price     Decimal  @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}
